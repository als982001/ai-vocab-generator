# 로그인 및 데이터 저장 작업 문서

- **작업 브랜치**: `feature/auth-and-supabase-migration`

## 1. 작업 목적

- **데이터 영속성 확보**: 현재 localStorage 기반 저장 방식은 기기/브라우저 변경 시 데이터가 유실됨. Supabase DB로 마이그레이션하여 어디서든 데이터 접근 가능하게 함.
- **인증 도입**: 인증된 유저만 서비스를 이용할 수 있도록 Google OAuth 로그인 구현.
- **서버 상태 관리 최적화**: TanStack Query를 도입하여 서버 데이터 캐싱, 로딩/에러 상태를 선언적으로 관리.

---

## 2. 현재 상태 분석

### 2.1 localStorage 사용 현황

**서비스 파일**: `app/services/localStorage.ts`

| 함수                                          | 역할                  | 호출 위치                   |
| --------------------------------------------- | --------------------- | --------------------------- |
| `saveAnalysis(words, imageName)`              | 분석 결과 저장        | `home-page.tsx:155`         |
| `getAnalysisHistory()`                        | 전체 히스토리 조회    | `history-page.tsx:80`       |
| `deleteAnalysis({historyId, targetWord})`     | 단어 삭제             | `history-page.tsx:111`      |
| `updateWordInAnalysis({...})`                 | 단어 수정             | `history-page.tsx:166, 189` |
| `addWordToAnalysis({historyId, deletedWord})` | 삭제 취소 (단어 복원) | `history-page.tsx:131`      |
| `clearHistory()`                              | 전체 삭제             | (미사용)                    |

### 2.2 현재 데이터 모델

```typescript
// app/types/index.ts
interface ISavedAnalysis {
  id: string; // crypto.randomUUID()
  words: IWord[];
  imageName: string;
  createdAt: string; // ISO 날짜
}

interface IWord {
  level: JlptLevel; // "N5" | "N4" | "N3" | "N2" | "N1"
  meaning: string;
  reading: string;
  word: string;
  box_2d?: number[]; // [ymin, xmin, ymax, xmax] (0~1000)
}
```

### 2.3 영향받는 파일

| 파일                                          | 영향                                   |
| --------------------------------------------- | -------------------------------------- |
| `app/services/localStorage.ts`                | **삭제** (Supabase 서비스로 대체)      |
| `app/features/dashboard/pages/home-page.tsx`  | `saveAnalysis` 호출부 변경             |
| `app/features/history/pages/history-page.tsx` | 모든 CRUD 함수 호출부 변경             |
| `app/features/auth/pages/login-page.tsx`      | Google OAuth 로그인 UI로 전면 교체     |
| `app/routes.ts`                               | 인증 가드 라우팅 추가                  |
| `app/root.tsx`                                | AuthProvider, QueryClientProvider 래핑 |

---

## 3. Supabase 테이블 설계

### 3.1 `analyses` 테이블 (분석 결과)

| 컬럼         | 타입                                      | 설명            |
| ------------ | ----------------------------------------- | --------------- |
| `id`         | `uuid` (PK, default: `gen_random_uuid()`) | 분석 결과 ID    |
| `user_id`    | `uuid` (FK → `auth.users.id`, NOT NULL)   | 소유 유저       |
| `image_name` | `text` (NOT NULL)                         | 업로드 이미지명 |
| `created_at` | `timestamptz` (default: `now()`)          | 생성일시        |

### 3.2 `words` 테이블 (추출 단어)

| 컬럼          | 타입                                                     | 설명                 |
| ------------- | -------------------------------------------------------- | -------------------- |
| `id`          | `uuid` (PK, default: `gen_random_uuid()`)                | 단어 ID              |
| `user_id`     | `uuid` (FK → `auth.users.id`, NOT NULL)                  | 소유 유저 (비정규화) |
| `analysis_id` | `uuid` (FK → `analyses.id`, ON DELETE CASCADE, NOT NULL) | 소속 분석 결과       |
| `word`        | `text` (NOT NULL)                                        | 일본어 단어          |
| `reading`     | `text` (NOT NULL)                                        | 후리가나             |
| `meaning`     | `text` (NOT NULL)                                        | 한국어 뜻            |
| `level`       | `text` (NOT NULL)                                        | JLPT 레벨 (N5~N1)    |
| `box_2d`      | `integer[]`                                              | 이미지 내 위치 좌표  |
| `created_at`  | `timestamptz` (default: `now()`)                         | 생성일시             |

> **비정규화 사유**: `user_id`를 `words`에 직접 두면 JOIN 없이 "내 단어 전체 조회"가 가능하고, RLS 정책도 서브쿼리 없이 단순 비교로 처리할 수 있음.

### 3.3 RLS (Row Level Security) 정책

```sql
-- analyses: 본인 데이터만 접근
ALTER TABLE analyses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can CRUD own analyses"
  ON analyses FOR ALL
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- words: user_id로 직접 접근 제어 (JOIN 불필요)
ALTER TABLE words ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can CRUD own words"
  ON words FOR ALL
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);
```

---

## 4. Phase 1 - Supabase 초기 설정

### 4.1 패키지 설치

```bash
npm install @supabase/supabase-js
```

### 4.2 환경 변수

```env
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIs...
```

### 4.3 Supabase 클라이언트 생성

**생성 파일**: `app/services/supabase.ts`

```typescript
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

### 4.4 타입 생성

**생성 파일**: `app/types/supabase.ts`

Supabase CLI로 DB 스키마 기반 타입을 자동 생성하거나, 수동으로 정의.

```typescript
export interface IAnalysisRow {
  id: string;
  user_id: string;
  image_name: string;
  created_at: string;
}

export interface IWordRow {
  id: string;
  user_id: string;
  analysis_id: string;
  word: string;
  reading: string;
  meaning: string;
  level: string;
  box_2d: number[] | null;
  created_at: string;
}
```

---

## 5. Phase 2 - 인증 (Google OAuth)

### 5.1 로그인 플로우

```
[로그인 페이지] → [Google OAuth 버튼 클릭]
    → Supabase signInWithOAuth({ provider: 'google' })
    → Google 인증 화면 → 콜백 → 세션 생성
    → [메인 페이지(/)로 리다이렉트]
```

### 5.2 AuthContext 생성

**생성 파일**: `app/contexts/AuthContext.tsx`

```typescript
// 제공할 값
interface IAuthContext {
  user: User | null; // Supabase User 객체
  isLoading: boolean; // 세션 확인 중 여부
  signInWithGoogle: () => Promise<void>;
  signOut: () => Promise<void>;
}
```

- `onAuthStateChange`로 세션 변화 감지
- 초기 로딩 시 `getSession()`으로 기존 세션 복원

### 5.3 Route Guard

**생성 파일**: `app/components/shared/ProtectedRoute.tsx`

- 인증되지 않은 유저 → `/login`으로 리다이렉트
- 인증된 유저가 `/login` 접근 → `/`로 리다이렉트

**라우팅 구조 변경** (`app/routes.ts`):

```typescript
// 변경 전
index("./features/dashboard/pages/home-page.tsx"),
route("/history", "./features/history/pages/history-page.tsx"),
route("/login", "./features/auth/pages/login-page.tsx"),

// 변경 후 (layout route로 보호)
route("/login", "./features/auth/pages/login-page.tsx"),
layout("./components/shared/ProtectedLayout.tsx", [
  index("./features/dashboard/pages/home-page.tsx"),
  route("/history", "./features/history/pages/history-page.tsx"),
]),
```

### 5.4 로그인 페이지 UI 변경

`app/features/auth/pages/login-page.tsx`:

- 기존 이메일/비밀번호 폼 → **Google 로그인 버튼 하나**로 교체
- 프로젝트 로고 + 간단한 설명 + Google 로그인 버튼 구성

### 5.5 유저 정보 표시 및 로그아웃 기능 및 버튼 추가

`app/components/shared/Sidebar.tsx`:

- user 데이터의 예시는 다음과 같음

```ts
{
    "id": "4bb724f8-2d0a-4ac0-91e5-bdaa74b9585f",
    "aud": "authenticated",
    "role": "authenticated",
    "email": "alsals982001@gmail.com",
    "email_confirmed_at": "2026-02-15T02:23:47.707074Z",
    "phone": "",
    "confirmed_at": "2026-02-15T02:23:47.707074Z",
    "last_sign_in_at": "2026-02-15T02:23:47.716642Z",
    "app_metadata": {
        "provider": "google",
        "providers": [
            "google"
        ]
    },
    "user_metadata": {
        "avatar_url": "https://lh3.googleusercontent.com/a/ACg8ocLr6mRjpYClgNdLLs5x7I3d-nFg2jUiNyQqgUx769MogLxKnTwS=s96-c",
        "email": "alsals982001@gmail.com",
        "email_verified": true,
        "full_name": "주재민",
        "iss": "https://accounts.google.com",
        "name": "주재민",
        "phone_verified": false,
        "picture": "https://lh3.googleusercontent.com/a/ACg8ocLr6mRjpYClgNdLLs5x7I3d-nFg2jUiNyQqgUx769MogLxKnTwS=s96-c",
        "provider_id": "100519661882036063839",
        "sub": "100519661882036063839"
    },
    "identities": [
        {
            "identity_id": "753b1238-6a5b-4bb2-a520-4105dfee16cc",
            "id": "100519661882036063839",
            "user_id": "4bb724f8-2d0a-4ac0-91e5-bdaa74b9585f",
            "identity_data": {
                "avatar_url": "https://lh3.googleusercontent.com/a/ACg8ocLr6mRjpYClgNdLLs5x7I3d-nFg2jUiNyQqgUx769MogLxKnTwS=s96-c",
                "email": "alsals982001@gmail.com",
                "email_verified": true,
                "full_name": "주재민",
                "iss": "https://accounts.google.com",
                "name": "주재민",
                "phone_verified": false,
                "picture": "https://lh3.googleusercontent.com/a/ACg8ocLr6mRjpYClgNdLLs5x7I3d-nFg2jUiNyQqgUx769MogLxKnTwS=s96-c",
                "provider_id": "100519661882036063839",
                "sub": "100519661882036063839"
            },
            "provider": "google",
            "last_sign_in_at": "2026-02-15T02:23:47.693014Z",
            "created_at": "2026-02-15T02:23:47.693072Z",
            "updated_at": "2026-02-15T02:23:47.693072Z",
            "email": "alsals982001@gmail.com"
        }
    ],
    "created_at": "2026-02-15T02:23:47.656611Z",
    "updated_at": "2026-02-15T02:23:47.778101Z",
    "is_anonymous": false
}
```

- 아이콘은 user.user_metadata.avatar_url을 이용해서 보여주게 수정
- 닉네임은 user.user_metadata.full_name을 보여주게 수정
- Freeplan 부분은 user.user_metadata.email을 보여주게 수정
- 유저 정보 보여주는 곳의 오른쪽에는 로그아웃 버튼(아이콘) 추가 밑 클릭하면 로그아웃하게 수정

---

## 6. Phase 3 - DB 마이그레이션 + TanStack Query (localStorage → Supabase)

> Phase 3과 4를 병합하여, Supabase 서비스 함수 작성과 TanStack Query 훅 래핑을 동시에 진행한다.
> 중간 단계(서비스 함수를 useEffect+setState로 호출)를 거치지 않아 작업 중복을 방지한다.

### 6.1 패키지 설치

```bash
npm install @tanstack/react-query
```

### 6.2 QueryClient 설정

**`app/root.tsx`**에 `QueryClientProvider` 추가.

### 6.3 Supabase CRUD 서비스 (데이터 계층)

**생성 파일**: `app/services/analysis.ts`

순수 async 함수로 Supabase와 직접 통신하는 계층. TanStack Query 훅의 `queryFn` / `mutationFn`으로 사용됨.

| 함수                                     | 대체 대상 (localStorage) | Supabase 쿼리                                      |
| ---------------------------------------- | ------------------------ | -------------------------------------------------- |
| `saveAnalysis(userId, words, imageName)` | `saveAnalysis`           | `analyses` INSERT → `words` 다건 INSERT            |
| `getAnalysisHistory(userId)`             | `getAnalysisHistory`     | `analyses` SELECT + `words` JOIN (created_at DESC) |
| `deleteWord(wordId)`                     | `deleteAnalysis`         | `words` DELETE (단어 1건 삭제)                     |
| `updateWord(wordId, meaning, level)`     | `updateWordInAnalysis`   | `words` UPDATE                                     |
| `restoreWord(analysisId, word)`          | `addWordToAnalysis`      | `words` INSERT                                     |

### 6.4 TanStack Query 커스텀 훅 (상태 관리 계층)

서비스 함수를 TanStack Query로 감싸 캐싱, 로딩/에러 상태, 낙관적 업데이트를 처리.

**생성 파일**: `app/features/history/hooks/useAnalysisHistory.ts`

```typescript
// 히스토리 조회
export function useAnalysisHistory() {
  return useQuery({
    queryKey: ["analysisHistory"],
    queryFn: () => getAnalysisHistory(userId),
  });
}
```

**생성 파일**: `app/features/dashboard/hooks/useSaveAnalysis.ts`

```typescript
// 분석 결과 저장
export function useSaveAnalysis() {
  return useMutation({
    mutationFn: (params) => saveAnalysis(params),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["analysisHistory"] });
    },
  });
}
```

**생성 파일**: `app/features/history/hooks/useWordMutations.ts`

```typescript
// 단어 삭제, 수정, 복원 뮤테이션 통합
export function useDeleteWord() { ... }
export function useUpdateWord() { ... }
export function useRestoreWord() { ... }
```

### 6.5 페이지 수정 사항

**`home-page.tsx`**:

- `saveAnalysis` (localStorage) → `useSaveAnalysis` 훅으로 교체
- 인증된 유저의 `userId`를 AuthContext에서 가져와 전달

**`history-page.tsx`**:

- `useEffect` + `getAnalysisHistory()` → `useAnalysisHistory` 훅으로 교체
- `handleDeleteWord`, `handleSaveEdit` → `useDeleteWord`, `useUpdateWord` 뮤테이션 훅으로 교체
- 삭제 취소(undo) → `useRestoreWord` 뮤테이션 훅으로 교체

### 6.6 삭제 대상

- `app/services/localStorage.ts` → 완전 삭제

### 6.7 TanStack Query 도입 이점

- **자동 캐싱**: 히스토리 페이지 재방문 시 API 재호출 없이 캐시된 데이터 즉시 표시
- **낙관적 업데이트**: 삭제/수정 시 UI를 먼저 업데이트하고 서버 요청 → UX 개선
- **로딩/에러 상태**: `isLoading`, `isError` 등 선언적 상태 관리
- **자동 리페칭**: 윈도우 포커스 시 최신 데이터 동기화

---

## 7. 전체 파일 변경 영향 범위

### 생성 파일

| 파일                                               | 역할                  |
| -------------------------------------------------- | --------------------- |
| `app/services/supabase.ts`                         | Supabase 클라이언트   |
| `app/services/analysis.ts`                         | 분석 결과 CRUD 서비스 |
| `app/types/supabase.ts`                            | Supabase 테이블 타입  |
| `app/contexts/AuthContext.tsx`                     | 인증 컨텍스트         |
| `app/components/shared/ProtectedLayout.tsx`        | 인증 가드 레이아웃    |
| `app/features/history/hooks/useAnalysisHistory.ts` | 히스토리 조회 훅      |
| `app/features/dashboard/hooks/useSaveAnalysis.ts`  | 분석 저장 뮤테이션 훅 |
| `app/features/history/hooks/useWordMutations.ts`   | 단어 CRUD 뮤테이션 훅 |

### 수정 파일

| 파일                                          | 변경 내용                                  |
| --------------------------------------------- | ------------------------------------------ |
| `app/root.tsx`                                | AuthProvider, QueryClientProvider 래핑     |
| `app/routes.ts`                               | ProtectedLayout 적용, 라우팅 구조 변경     |
| `app/features/auth/pages/login-page.tsx`      | Google OAuth 버튼 UI로 전면 교체           |
| `app/features/dashboard/pages/home-page.tsx`  | `saveAnalysis` → useSaveAnalysis 훅 사용   |
| `app/features/history/pages/history-page.tsx` | localStorage 함수 → TanStack Query 훅 사용 |

### 삭제 파일

| 파일                           | 사유                        |
| ------------------------------ | --------------------------- |
| `app/services/localStorage.ts` | Supabase 서비스로 완전 대체 |

---

## 8. 작업 순서 요약

```
Phase 1: Supabase 초기 설정
  └─ 패키지 설치, 환경변수, 클라이언트 생성, 테이블 & RLS 설정

Phase 2: 인증 (Google OAuth)
  └─ AuthContext, 로그인 페이지 UI, ProtectedLayout, 라우팅 변경

Phase 3: DB 마이그레이션 + TanStack Query
  └─ QueryClientProvider 설정, Supabase 서비스 함수 + TanStack Query 훅 동시 작성,
     페이지에서 훅 사용으로 전환, localStorage.ts 삭제
```
